# Migrations

This directory contains all Alembic database migrations for Crumbs.

## What is Alembic?

Alembic is a database migration tool for SQLAlchemy. Every change to the
database schema (adding a table, adding a column, changing a type) is tracked
as a versioned migration file. This ensures the database schema stays in sync
across local development, staging, and production.

## How it works

1. You change a model in `src/models/`
2. You run `uv run alembic revision --autogenerate -m "description"`
3. Alembic compares your models against the current DB schema and generates a migration file in `versions/`
4. You review the generated file to make sure it looks correct
5. You run `uv run alembic upgrade head` to apply it to the database

## Migration history

| Revision     | Description                                                         |
| ------------ | ------------------------------------------------------------------- |
| 6bc9b4d4f2a9 | Initial schema — users, restaurants, reviews, tags, restaurant_tags |
| (next)       | replace api_key_hash with plain api_key on users                    |

## Common commands

```bash
# Apply all pending migrations
uv run alembic upgrade head

# Roll back one migration
uv run alembic downgrade -1

# Roll back all migrations
uv run alembic downgrade base

# See current migration status
uv run alembic current

# See migration history
uv run alembic history

# Generate a new migration
uv run alembic revision --autogenerate -m "your description here"
```

## Important rules

- Never edit a migration file that has already been applied to production
- Always review autogenerated migrations before running them — Alembic is good but not perfect
- Every schema change goes through a migration, even in development
- Migration files are committed to git alongside the code changes that require them
